#! /bin/sh
# create_mex_files.sh
# Create the MEX files suitable for using the StructPack programs in Matlab
# or Octave
#
# Date: 28 March 2011
# Author: Pablo Martinez Naredo <pmnaredo@gmail.com>

prefix="@prefix@"
exec_prefix="@exec_prefix@"

STRUCTPACK_INCLUDE_DIR="@includedir@"
STRUCTPACK_LIB_DIR="@libdir@"
STRUCTPACK_LIB_FLAGS="${STRUCTPACK_LIB_DIR}/libstructpack.a"

DFFTPACK_LIB_FLAGS="@dfftpack_lib_flags@"

BLAS_LIB_FLAGS="@blas_lib_flags@"

MKL_LIB_DIR_FLAG="@mkl_lib_dir_flag@"
MKL_LIB_FLAGS="@mkl_cc_lib_flags@"

#OPENMP_FLAGS="-Wl,@openmp_fc_flags@ -lgomp"

# Flags for Octave
#
MEX="mkoctfile"
MEXFLAGS="--mex -v"

# Flags for Matlab
#
#MEX=mex
#MEXFLAGS=-v #-f $(MATLABROOT)/matopts.sh

export CC="@CC@"
export DL_LD="@FC@"

case $DL_LD in
ifort)
  OPENMP_LIB_FLAGS="-liomp5"
  ;;
*)
  OPENMP_LIB_FLAGS="-lgomp"
  ;;
esac

EXTRA_LIB_FLAGS="@intel_extra_fc_lib_flags@"

# dts
#
$MEX $MEXFLAGS -I$STRUCTPACK_INCLUDE_DIR mex_dts.c \
    $STRUCTPACK_LIB_FLAGS \
    $DFFTPACK_LIB_FLAGS \
    $BLAS_LIB_FLAGS \
    $MKL_LIB_DIR_FLAG $MKL_LIB_FLAGS \
    $OPENMP_LIB_FLAGS \
    $EXTRA_LIB_FLAGS


# dpis
#
$MEX $MEXFLAGS -I$STRUCTPACK_INCLUDE_DIR mex_dpis.c \
    $STRUCTPACK_LIB_FLAGS \
    $DFFTPACK_LIB_FLAGS \
    $BLAS_LIB_FLAGS \
    $MKL_LIB_DIR_FLAG $MKL_LIB_FLAGS \
    $OPENMP_LIB_FLAGS \
    $EXTRA_LIB_FLAGS

# dt
#
$MEX $MEXFLAGS -I$STRUCTPACK_INCLUDE_DIR mex_dt.c \
    $STRUCTPACK_LIB_FLAGS \
    $DFFTPACK_LIB_FLAGS \
    $BLAS_LIB_FLAGS \
    $MKL_LIB_DIR_FLAG $MKL_LIB_FLAGS \
    $OPENMP_LIB_FLAGS \
    $EXTRA_LIB_FLAGS

# dtspg
#
$MEX $MEXFLAGS -I$STRUCTPACK_INCLUDE_DIR mex_dtspg.c \
    $STRUCTPACK_LIB_FLAGS \
    $DFFTPACK_LIB_FLAGS \
    $BLAS_LIB_FLAGS \
    $MKL_LIB_DIR_FLAG $MKL_LIB_FLAGS \
    $OPENMP_LIB_FLAGS \
    $EXTRA_LIB_FLAGS
